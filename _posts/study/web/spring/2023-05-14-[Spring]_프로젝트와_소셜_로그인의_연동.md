---
layout: post
title: "[Spring] 프로젝트와 소셜 로그인의 연동"
subtitle: Spring
date: '2023-05-14 12:40:00 +0900'
category: study
tags: spring web
image:
    path: /assets/img/web/spring/logo.png
---

소셜 로그인 기능을 프로젝트에 적용해봅니다.

<!--more-->

* this unordered seed list will be replaced by the toc
{:toc}
<br>

현재까지 작성한 프로젝트의 경우 소셜 로그인을 수행할 때 ClubAuthMember와 같은 객체를 사용하지 않는 상태입니다.<br>
소셜 로그인 처리 시 사용자의 이메일 정보를 추출하고 현재 데이터베이스와 연동해 사용자 정보를 관리해야 합니다.<br>
또한 기존 로그인 방식과 소셜 로그인 방식 모두 동일하게 동작하도록 만들어야 합니다.<br>

---
<br>

# 1. ClubOAuth2UserDetailsService 생성
---
<br>

![1](/assets/img/web/spring/2023-05-14-[Spring]_프로젝트와_소셜_로그인의_연동/1.png)
<br>

앞서 말한 작업을 수행하기 위해 OAuth2UserService를 알아야 합니다.<br>
OAuth2UserService는 인터페이스로 UserDetailsService의 OAuth 버전이라고 생각할 수 있습니다. 이를 구현하는 것은 OAuth의 인증 결과를 처리한다는 의미입니다.<br>
ClubOAuth2UserDetailsService는 DefaultOAuth2UserService를 상속받은 후 `@Log4j2`를 통해 동작 여부를 살펴볼 수 있도록 작성합니다. 또한 `@Service`를 작성해 스프링의 빈으로 자등으로 등록되게 합니다.<br>
OAuth2UserRequest 타입의 userRequest로부터 정보를 추출해 콘솔창에 출력하며 oAuth2User로 컨버트 후 반환하도록 작성합니다.<br>


# 2. ClubOAuth2UserDetailsService 생성 결과
---
<br>

![2](/assets/img/web/spring/2023-05-14-[Spring]_프로젝트와_소셜_로그인의_연동/2.png)
<br>

프로젝트를 실행한 뒤 구글로 로그인을 진행할 경우 위의 그림과 같은 로그들이 출력되고 sub, picture, email, email_verified 항목이 출력되는 것을 확인할 수 있습니다.<br>


# 3. ClubOAuth2UserDetailsService - saveSocialMember() 작성
---
<br>

![3](/assets/img/web/spring/2023-05-14-[Spring]_프로젝트와_소셜_로그인의_연동/3.png)
<br>

OAuth2user를 이용해 로그인한 사용자의 이메일 주소를 알아낼 수 있고 이를 활용해 데이터베이스에 추가하는 작업을 수행할 수 있습니다. 이 때 임의로 패스워드를 지정해 데이터베이스에 저장할 경우 문제가 될 수 있습니다. 이는 조금 뒤에서 추가로 다루도록 하겠습니다.<br>
데이터베이스에 저장을 위해 ClubMemberRepository와 PasswordEncoder를 주입받도록 `@RequirredArgsConstructor`를 사용하고 saveSocialMember()를 작성합니다.<br>
eamil을 파라미터로 받아와 데이터베이스에 존재하는지 여부를 확인한 뒤 없는 경우에만 데이터베이스에 등록하도록 합니다.<br>


# 4. ClubOAuth2UserDetailsService - saveSocialMember() 결과
---
<br>

![4](/assets/img/web/spring/2023-05-14-[Spring]_프로젝트와_소셜_로그인의_연동/4.png)
<br>

saveSocialMember()를 작성한 뒤 소셜 로그인을 수행한 결과 구글 이메일 계정이 데이터베이스에 등록된 것을 확인할 수 있습니다.<br>


# 5. ClubAuthMemberDTO 수정
---
<br>

![5](/assets/img/web/spring/2023-05-14-[Spring]_프로젝트와_소셜_로그인의_연동/5.png)
<br>

DefaultOAuth2UserService()의 loadUser()의 경우 일반적인 로그인과는 다르게 OAuth2User 타입의 객체를 반환했습니다. 때문에 소셜 로그인을 진행한 후 member 화면을 살펴보면 이메일 주소가 아닌 사용자의 번호가 출력됩니다.<br>
이를 해결하기 위해 OAuth2User 타입을 ClubAuthMemberDTO 타입으로 사용하도록 처리합니다.<br>
ClubAuthMemberDTO는 OAuth2User의 인터페이스를 구현하도록 수정합니다. OAuth2User의 인증 결과는 attributes에 담겨있기 때문에 ClubAuthMember에 attr 변수를 만들어 getAttributes() 메소드를 override 합니다.<br>


# 6. ClubOAuth2UserDetailsService - 리턴 타입 수정
---
<br>

![6](/assets/img/web/spring/2023-05-14-[Spring]_프로젝트와_소셜_로그인의_연동/6.png)
<br>

loadUser()의 경우 oAuth2User를 반환하는 것이 아닌 oAuth2User에서 email만을 추출한 뒤 saveSocialMember()에서 나오는 결과를 사용해 ClubAuthMemberDTO를 생성하고 이를 반환하도록 수정합니다.<br>


# 7. ClubOAuth2UserDetailsService - 리턴 타입 수정 결과
---
<br>

![7](/assets/img/web/spring/2023-05-14-[Spring]_프로젝트와_소셜_로그인의_연동/7.png)
<br>

'/sample/member' 화면을 소셜 로그인 후 접근한 결과 정상적으로 이메일이 출력되는 것을 확인할 수 있습니다.<br>


# 8. ClubLoginSuccessHandler 생성
---
<br>

![8](/assets/img/web/spring/2023-05-14-[Spring]_프로젝트와_소셜_로그인의_연동/8.png)
<br>

앞서 


# 9. SecurityConfig - ClubLoginSuccessHandler 작성
---
<br>

![9](/assets/img/web/spring/2023-05-14-[Spring]_프로젝트와_소셜_로그인의_연동/9.png)
<br>



# 10. SecurityConfig - ClubLoginSuccessHandler 결과
---
<br>

![10](/assets/img/web/spring/2023-05-14-[Spring]_프로젝트와_소셜_로그인의_연동/10m.png)
<br>



# 11. ClubLoginSuccessHandler - onAutheticationSuccess() 수정
---
<br>

![11](/assets/img/web/spring/2023-05-14-[Spring]_프로젝트와_소셜_로그인의_연동/11.png)
<br>



# 12. SecurityConfig - successHandler() 수정
---
<br>

![12](/assets/img/web/spring/2023-05-14-[Spring]_프로젝트와_소셜_로그인의_연동/12.png)
<br>



# 13. SecurityConfig - ClubLoginSuccessHandler 소셜 로그인 결과
---
<br>

![13](/assets/img/web/spring/2023-05-14-[Spring]_프로젝트와_소셜_로그인의_연동/13.png)
<br>



# 14. SecurityConfig - rememberMe() 추가
---
<br>

![14](/assets/img/web/spring/2023-05-14-[Spring]_프로젝트와_소셜_로그인의_연동/14.png)
<br>



# 15. SecurityConfig - rememberMe() 추가 결과
---
<br>

![15](/assets/img/web/spring/2023-05-14-[Spring]_프로젝트와_소셜_로그인의_연동/15.png)
<br>



# 16. SecurityConfig - rememberMe() 쿠키 확인
---
<br>

![16](/assets/img/web/spring/2023-05-14-[Spring]_프로젝트와_소셜_로그인의_연동/16.png)
<br>



